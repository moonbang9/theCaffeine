<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/index}">

<head>
  <meta charset="UTF-8">
  <title>출고 관리</title>
</head>

<body>
  <div layout:fragment="content">




    <!-- Content wrapper -->
    <div class="content-wrapper">
      <!-- Content -->
      <div class="container-xxl flex-grow-1 container-p-y">
        <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">영업 관리 /</span> 주문 출고 관리</h4>


        <!-- 테스트 -->
        <div class="col-xl-6" style="width: 100%;">
          <div class="nav-align-top mb-4">
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item">
                <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#navs-top-home" aria-controls="navs-top-home" aria-selected="true">
                  미처리
                </button>
              </li>
              <li class="nav-item">
                <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-top-profile" aria-controls="navs-top-profile" aria-selected="false">
                  처리
                </button>
              </li>              
            </ul>
            <div class="tab-content">

              <div class="tab-pane fade show active" id="navs-top-home" role="tabpanel">
                <div class="card-body">
                  <!-- <form id="formAccountSettings" method="POST" onsubmit="return false"> -->
                  <div class="row">
      
                    <div class="mb-3 row col-md-6">
                      <label for="html5-search-input" class="col-md-3 col-form-label">거래처 코드</label>
                      <div class="col-md-9">
                        <input class="form-control" type="search" id="sCliCd" placeholder="거래처 코드">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">                      
                    </div>
                    <div class="mb-3 row col-md-6">
                      <label for="html5-search-input" class="col-md-3 col-form-label">거래처명</label>
                      <div class="col-md-9">
                        <input class="form-control" type="search" id="sCliName" placeholder="거래처명">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">                      
                    </div>
                    
      
                    <div class="mb-3 row col-md-6">
                      <label for="html5-date-input" class="col-md-3 col-form-label">주문일</label>
                      <div class="col-md-9">
                        <input class="form-control" type="date" id="sMinOdDt" value="">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">
                      <label for="html5-date-input" class="col-md-1 col-form-label">~</label>
                      <div class="col-md-9">
                        <input class="form-control" type="date" id="sMaxOdDt">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">
                      <label for="html5-date-input" class="col-md-3 col-form-label">납기일</label>
                      <div class="col-md-9">
                        <input class="form-control" type="date" id="sMinDueDt">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">
                      <label for="html5-date-input" class="col-md-1 col-form-label">~</label>
                      <div class="col-md-9">
                        <input class="form-control" type="date" id="sMaxDueDt" placeholder="231465">
                      </div>
                    </div>
      
                    <div class="mb-3 row col-md-6">
                      <label for="html5-search-input" class="col-md-3 col-form-label">주문 담당자</label>
                      <div class="col-md-9">
                        <input class="form-control" type="search" id="sCliCd" placeholder="주문 담당자명">
                      </div>
                    </div>
                    <div class="mb-3 row col-md-6">                      
                    </div>
                    <div class="mb-3 row col-md-6">
                      <label for="html5-date-input" class="col-md-3 col-form-label"></label>
                      <div class="col-md-9">
                        <button type="submit" class="btn btn-primary me-2" id="sSearchBtn">검색</button>
                        <button type="reset" class="btn btn-outline-secondary" id="sResetBtn">초기화</button>
                      </div>
                    </div>
      
                  </div>
      
                </div>

                <!-- 그리드 -->
                <div id="sendTable" >
                </div>


              </div>



              <div class="tab-pane fade" id="navs-top-profile" role="tabpanel">
                <p>
                  처리 작업중
                </p>
              </div>  

            </div>
          </div>
        </div>
        <!-- 테스트 -->



      </div>
    </div>
  </div>
  

  <script>

    // 검색 조건 초기화
    resetBtn.addEventListener("click", e => {
      document.getElementById('cliCd').value = null;
      document.getElementById('cliName').value = null;
      document.getElementById('cliChg').value = null;
      document.getElementById('pdCd').value = null;
      document.getElementById('pdName').value = null;
      document.getElementById('odChg').value = null;
      document.getElementById('minOdDt').value = null;
      document.getElementById('maxOdDt').value = null;
      document.getElementById('minDueDt').value = null;
      document.getElementById('maxDueDt').value = null;
      //stList = null;
    })

    // 검색 버튼 누르면 조건대로 검색한 주문목록 불러오기
    searchBtn.addEventListener("click", e => {
      checkList();

      let cliCd = document.getElementById('cliCd').value;
      let cliName = document.getElementById('cliName').value;
      let cliChg = document.getElementById('cliChg').value;
      let pdCd = document.getElementById('pdCd').value;
      let pdName = document.getElementById('pdName').value;
      let odChg = document.getElementById('odChg').value;
      let minOdDt = document.getElementById('minOdDt').value;
      let maxOdDt = document.getElementById('maxOdDt').value;
      let minDueDt = document.getElementById('minDueDt').value;
      let maxDueDt = document.getElementById('maxDueDt').value;

      if (stList.length == 0) {
        stList = null;
      }

      let param = { cliCd, cliName, cliChg, pdCd, pdName, odChg, minOdDt, maxOdDt, minDueDt, maxDueDt, stList }

      console.log(param);
      fetch("/sales/ajax/orderMng", {
        method: "post",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(param)
      })
        .then(res => res.json())
        .then(res => table.setData(res))
    })

    // 조건검색 : 체크된 주문상태만 배열에 담기
    function checkList() {
      // 주문상태 배열 초기화
      stList = [];

      // Name이 odSt인 속성 취득
      const odSt = document.getElementsByName("odSt");
      // 취득한 속성 만큼 루프
      for (let i = 0; i < odSt.length; i++) {
        // 속성중에 체크 된 항목이 있을 경우
        if (odSt[i].checked == true) {
          stList.push(odSt[i].value);
        }
      }
    }

    // 주문 목록 그리드 만들기
    var table = new Tabulator("#sendTable", {
      layout: "fitColumns",
      height: "100%",
      //responsiveLayout: "hide",
      rowHeader: { formatter: "rownum", headerSort: false, width: 70, hozAlign: "center", resizable: false, frozen: true },
      resizableColumnFit: true,
      layout: "fitColumns",
      columns: [ //주문일, 거래처, 제품명, 주문금액(부분합), 납기일, 상태, 인쇄
        // { title: "주문번호", field: "odNo", width: 70, hozAlign: "center" },
        // { title: "주문일", field: "odDt", width: 90, hozAlign: "center" },
        // { title: "거래처", field: "cliName", width: 120, hozAlign: "center" },
        // { title: "거래처 담당자", field: "cliChg", width: 100, hozAlign: "center" },
        // { title: "제품", field: "pd", width: 400, hozAlign: "center" },
        // { title: "할인율", field: "dcRate", width: 50, hozAlign: "center" },
        // { title: "총 금액", field: "totalPrice", width: 90, hozAlign: "center" },
        // { title: "주문 담당자", field: "odChg", width: 80, hozAlign: "center" },
        // { title: "납기일", field: "dueDt", width: 90, hozAlign: "center" },
        // { title: "주문상태", field: "st", width: 100, hozAlign: "center" },
        // { title: "인쇄", field: "week", width: 160, hozAlign: "center" }
      ],
    });

    // 행 클릭시 모달 띄우고 해당 주문정보 보여주기
    table.on("rowClick", function (e, row) {
      const myModal = new bootstrap.Modal('#pdStockModal', {
        keyboard: false
      })
      const modalToggle = document.getElementById('pdStockModal');
      myModal.show(modalToggle);

      let odNo = row.getData().odNo;
      getOdInfo(odNo);
    });


    //주문 정보 불러오기
    function getOdInfo(odNo) {
      fetch("/sales/ajax/odInfo?odNo=" + odNo)
        .then(res => res.json())
        .then(res => {
          let info = res.odInfo;
          let list = res.odPdList;

          getInfo(info);
          getList(list);
        });
    }

    

    
  </script>
  </div>


</body>

</html>