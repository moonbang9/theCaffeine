<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/index}">
<head>
<meta charset="UTF-8">
<title>facility</title>
</head>
<body>
	<div layout:fragment="content">
		<h1>점검 관리</h1>
		<div id="example-table">
		<div class="divider text-start">
                        <div class="divider-text">설비 관리</div>
                      </div>
			<!-- Vertically Centered Modal -->
			<div class="col-lg-4 col-md-6">
				<div class="mt-3">
					<!-- Button trigger modal -->
					<button type="button" class="btn btn-primary"
						data-bs-toggle="modal" data-bs-target="#modalCenter" id="addInsp">
						점검 등록</button>

					
					<!-- Modal -->
					<div class="modal fade" id="modalCenter" tabindex="-1"
						aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="modalCenterTitle">비가동 처리</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"
										aria-label="Close"></button>
								</div>
								<div class="modal-body" id="inspectionForm">
								<div class="row">
										<div class="col mb-3">
											<div class="input-group" style="display: none;">
												<span class="input-group-text" id="basic-addon14">점검 코드</span>
												<input type="number" class="form-control" id="inspectionCd"
													aria-describedby="basic-addon14" readonly>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col mb-3">
											<div class="input-group">
												<span class="input-group-text" id="basic-addon14">설비명</span>
												<select class="form-select" id="fcltName" >
												<option selected value="">선택</option>
													<option  th:each="fclt : ${fcltNames}" th:value="${fclt.fcCd}" th:text="${fclt.fcName}">
													
												</select>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col mb-3">
											<div class="input-group">
												<span class="input-group-text" id="basic-addon14">점검일자</span>
												<div class="col-md-10">
						                          <input class="form-control" type="date" value="2024-04-01" id="inspectionDt">
						                        </div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col mb-3">
											<div class="input-group">
												<span class="input-group-text" id="basic-addon14">담당자</span>
												<input type="text" class="form-control" id="chargeofins"
													aria-describedby="basic-addon14">
											</div>
										</div>
									</div>

									<div class="row">
										<div class="col mb-3">
											<div class="input-group">
												<label class="input-group-text" for="inputGroupSelect01">점검 구분</label>
												<select class="form-select" id="inspectionCat">
												<option selected value="">선택</option>
													<option value="1">정기</option>
													<option value="2">수시</option>
													<option value="3">기타</option>
												</select>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col mb-3">
											<div class="input-group">
												<label class="input-group-text" for="inputGroupSelect01">판정</label>
												<select class="form-select" id="conclusion">
													<option selected value="">선택</option>
													<option value="적합">적합</option>
													<option value="부적합">부적합</option>
													
												</select>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col mb-3">
									<div class="input-group">
			                        <span class="input-group-text">점검 내용</span>
			                        <textarea class="form-control" aria-label="With textarea" id="inspectionContent"></textarea>
			                      </div>
			                      </div>
									</div>
									
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-outline-secondary"
										data-bs-dismiss="modal">취소</button>
									<button type="button" style="display: block;" class="saveInspBtn">등록</button>
									<button style="display: none;" type="button" class="btn btn-primary" id="updateInspBtn">수정</button>
								</div>
							</div>
						</div>
					</div>
					<!-- END OF Modal -->
				</div>
			</div>
			<div id="inspListTable"></div>
		</div>
	</div>
	
	<script>
	
	//테이블 생성 
	var insptable = new Tabulator("#inspListTable", {
	    //layout:"fitColumns",
	    height:"100%",
	    rowHeader:{formatter:"rownum", headerSort:false, width:84, hozAlign:"center", resizable:false, frozen:true},
	    //resizableColumnFit:true,
	   
	    columns:[
	        {title:"점검 코드", field:"insCd", width:100, hozAlign:"center"},
	        {title:"설비 코드", field:"fcCd", width:195, hozAlign:"center"}, 
	        {title:"비가동 코드", field:"nonopCd", width:100, hozAlign:"center"},
	        {title:"점검일", field:"insDt", width:150, hozAlign:"center"},
	        {title:"점검 구분", field:"insCat", width:150, hozAlign:"center"},
	        {title:"점검 내용", field:"insCont", width:160, hozAlign:"center"},
	        {title:"판정", field:"cc", width:100, hozAlign:"center"}, 
	        {title:"담당자", field:"chg", width:100, hozAlign:"center"}
	    ],
	});
	
	//클릭 시 단건 데이터 불러오기
	insptable.on("rowClick", function(e, row){
		saveInspBtn.style.display="none";
		updateInspBtn.style.display="block";
		let fcCd = row.getData().insCd;
		console.log(insCd);
		fetch("/fclt/inspectionlist/"+ insCd)
		.then(res => res.json())
		.then(res => {
			console.log(res);
			const myModal = new bootstrap.Modal('#modalCenter', {
				  keyboard: false
				})
			const modalToggle = document.getElementById('modalCenter'); 
			myModal.show(modalToggle);
			getInfo(res);
		})
	});
	
	//등록 데이터 비워주기 
	
	addInsp.addEventListener("click",function(){
		fcltName.value="";
		inspectionDt.value = "";
		chargeofins.value = "";
		inspectionCat.value = "선택";
		conclusion.value = "";
		inspectionContent.value = "선택";
	});
	
	function getInfo(obj){
		inspectionCd.value = obj.insCd;
		fcltName.value=obj.fcName;
		inspectionDt.value = obj.insDt;
		chargeofins.value = obj.chg;
		inspectionCat.value = obj.insCat;
		conclusion.value = obj.cc;
		inspectionContent.value = obj.insCont;
		
		saveBtn.style.display="block";
		updateBtn.style.display="none";
	}
	
	listReq();
	
	// 원자재 목록 데이터
	function listReq() {
		fetch("/fclt/getinspection")
		.then(res => res.json())
		.then(res =>{
			console.log(res)
			fclttable.setData(res)} )
		
	}
	
	saveInspBtn.addEventListener("click", e=> {
if(inspectionDt.value == ""){
	alert("점검일자가 입력되지 않았습니다.");
	inspectionDt.focus();
}else {
	saveReq();
}
})

	saveInspBtn.addEventListener("click", e=> {
			saveReq();
		}
	})
	
	// 등록 요청 (미완성)
	function saveReq() {
		const insDt= inspectionDt.value;
		const insCd= fcltstatus.value;
		const insCat= chargeofins.value;
		const insCont= manufacturingCom.value;
		const cc= strDate.value;
		const chg= inspectionCycle.value;
		const fcCd = durationTime.value;
		const nonopCd = durationTime.value;
		let param = {insCd, insDt,insCat,insCont,cc,chg,fcCd,nonopCd};
		console.log(param);
		fetch("/fclt/insertinsp",{
			method : "post",
			headers: {
			      "Content-Type": "application/json",
			    },
			body : JSON.stringify(param)
		})
		.then(res => res.json())
		.then(res => saveRes(res))
	}
	
	// 등록 응답
	function saveRes(res) {
		alert("설비등록이 완료되었습니다.");
		location.href= "/fclt/facilitylist"
	}
	</script>
</body>
</html>